. "$genapp_functions/core"

install_drush() {
    unzip -q "$plugin_dir/lib/drush-5.8.zip" -d "$app_dir/lib/drush"
}

install_drupal() {
    if [ -e "$app_dir/lib/newrelic-php" ]; then
        echo "Writing framework to NewRelic configuration"
        echo "newrelic.framework = \"drupal\"" >> "$app_dir/conf/php.ini"
    fi

    . "$(config_file)"

    echo "Installing Drupal"

    _curdir="$PWD"
    cd "$app_dir/app"
        _name=$(metadata drupal_name "Drupal@CloudBees")
        _username=$(metadata drupal_user "admin")
        _password=$(metadata drupal_pass "password")
        _mail=$(metadata drupal_mail "admin@example.com")
        _profile=$(metadata drupal_profile "standard")

        _sql_result=$(drush sql-query "SHOW TABLES")
        if [ "$_sql_result" == "" ]; then
            drush --yes site-install "${_profile}" --clean-url=0 \
            --account-name="${_username}" --account-pass="${_password}" \
            --site-name="${_name}" --site-mail="${_mail}" \
            --account-mail="${_mail}"
        fi

        echo "Rewriting permissions post-install"
        chmod -R ugo-w,o-rx "$PWD"
        for _dir in \
        modules themes sites/default/modules sites/default/themes
        do
            if [ -e "$_dir" ]; then
                chmod -R u+w "$_dir"
            fi
        done
        if [ -e sites/default/files ]; then
            chmod -R ug+w sites/default/files
        fi

        echo "Checking for updates with Drush"
        set +e
            drush pm-refresh
        set -e
    cd "$_curdir"
}