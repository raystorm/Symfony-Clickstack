. "$genapp_functions/core"

config_drush() {
    echo "Configuring Drush"
    install -m 600 "$plugin_dir/conf/drush.ini" "$app_dir/.drushini"
    install -m 600 "$app_dir/conf/msmtp.conf" "$app_dir/.msmtprc"
    sed -i "2iapp_dir = $app_dir" "$app_dir/.drushini"
}

install_drupal() {
    if [ -e "$app_dir/lib/newrelic-php" ]; then
        echo "Writing framework to NewRelic configuration"
        echo "newrelic.framework = drupal" >> "$app_dir/conf/php.ini"
    fi

    echo "Writing httpd config"
    sed -i "1i$(cat "$plugin_dir/conf/httpd.head.conf")" "$app_dir/conf/httpd.head.conf"
    sed -i "1i$(cat "$plugin_dir/conf/httpd.site.conf")" "$app_dir/conf/httpd.site.conf"

    echo "Setting up drupal"
    . "$(config_file)"
    export PHPRC="$HOME/.drushini"

    _curdir="$PWD"
    cd "$app_dir/app"
        echo "Checking if Drupal is already installed"
        _name=$(metadata drupal_name "Drupal@CloudBees")
        _username=$(metadata drupal_user "admin")
        _password=$(metadata drupal_pass "password")
        _mail=$(metadata drupal_mail "admin@example.com")
        _profile=$(metadata drupal_profile "standard")
        _sql_result=$(drush sql-query "SHOW TABLES")

        if [ "$_sql_result" == "" ]; then
            echo "Installing Drupal"
            drush --yes site-install "${_profile}" --account-mail="${_mail}" \
            --account-name="${_username}" --account-pass="${_password}" \
            --site-name="${_name}" --site-mail="${_mail}"
        fi

        echo "Rewriting permissions post-install"
        chmod -R g-w,o-rwx "$app_dir/app"

        for _dir in \
        modules themes sites/default/modules sites/default/themes
        do
            if [ -e "$_dir" ]; then
                chmod -R g+w "$_dir"
            fi
        done
        if [ -e sites/default/files ]; then
            chmod -R g+w sites/default/files
        fi

        echo "Checking for updates with Drush"
        set +e
            drush pm-refresh
        set -e
    cd "$_curdir"

    echo "Cleaning up post-install"
    rm -f "$app_dir/.msmtprc"
    rm -f "$app_dir/.drushini"
}