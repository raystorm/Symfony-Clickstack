# -*-shell-script-*-

. "$genapp_functions/core"

config_drush() {
    echo "Configuring Drush"
    install -m 600 "$plugin_dir/conf/drush.ini" "$app_dir/.drushini"
    sed -i "2iapp_dir = $app_dir" "$app_dir/.drushini"
}

install_drupal() {
    if [ -e "$app_dir/plugins/newrelic" ]; then
        echo "Writing framework to NewRelic configuration"
        echo "newrelic.framework = drupal" >> "$app_dir/conf/php.ini"
    fi

    echo "Writing httpd config"
    paste "$plugin_dir/conf/drupal.head.conf" "$app_dir/conf/httpd.head.conf" \
    > "$app_dir/conf/httpd.head.conf"
    paste "$plugin_dir/conf/drupal.site.conf" "$app_dir/conf/httpd.site.conf" \
    > "$app_dir/conf/httpd.site.conf"

    echo "Setting up drupal"
    . "$control_dir/config"
    export PHPRC="$app_dir/.drushini"

    _curdir="$PWD"
    cd "$app_dir/app"
        echo "Checking if Drupal is already installed"
        _name=$(parse drupal name -d Drupal@CloudBees)
        _username=$(parse drupal user -d admin)
        _password=$(parse drupal pass -d password)
        _mail=$(parse drupal mail -d admin@example.com)
        _profile=$(parse drupal profile -d standard)
        _sql_result=$(drush sql-query "SHOW TABLES")

        if [ "$_sql_result" == "" ]; then
            echo "Installing Drupal"
            drush --yes site-install "${_profile}" --account-mail="${_mail}" \
            --account-name="${_username}" --account-pass="${_password}" \
            --site-name="${_name}" --site-mail="${_mail}"
        fi

        echo "Rewriting permissions post-install"
        chmod -R g-w,o-rwx "$app_dir/app"

        for _dir in \
        modules themes sites/default/modules sites/default/themes
        do
            if [ -e "$_dir" ]; then
                chmod -R g+w "$_dir"
            fi
        done
        if [ -e sites/default/files ]; then
            chmod -R g+w sites/default/files
        fi

        echo "Checking for updates with Drush"
        set +e
            drush pm-refresh
        set -e
    cd "$_curdir"

    echo "Cleaning up post-install"
    rm -f "$app_dir/.drushini"
}